<script lang="ts">
  import { signer, signerAddress } from "svelte-ethers-store";
  import Button from "$components/Button.svelte";
  import FormPanel from "$components/FormPanel.svelte";
  import Input from "$components/Input.svelte";
  import { op, validateFields } from "../../utils";
  import { addressValidate, required } from "../../validation";
  import ContractDeploy from "$components/ContractDeploy.svelte";
  import {
    EmissionsERC20,
    type ERC20Config,
    type StateConfig,
    type EmissionsERC20DeployArgs,
    CreateERC20,
  } from "rain-sdk";
  import { concat, parseUnits } from "ethers/lib/utils";
  import Switch from "$components/Switch.svelte";

  let deployPromise;

  let fields: any = {};

  let fixedSupply = false,
    faucets = false;
  let blocks = 100,
    units = 0;

  let erc20name = "MyToken";
  let erc20symbol = "MyTKN";

  let ownerAddress = $signerAddress;
  let initSupply = 0;
  let amount = 0;

  const deployEmissions = async (fieldValues) => {
    // GET THE SOURCE

    let newEmissionsERC20, vmStateConfig: StateConfig;

    const Amount = fixedSupply ? amount : 0;

    if (faucets) {
      vmStateConfig = new CreateERC20(ownerAddress, Amount, {
        blocks: blocks,
        units: units,
      });
    } else {
      vmStateConfig = new CreateERC20(ownerAddress, Amount);
    }

    let erc20Config: ERC20Config;
    erc20Config = {
      name: fieldValues.erc20name,
      symbol: fieldValues.erc20symbol,
      distributor: fieldValues.ownerAddress,
      initialSupply: parseUnits(fieldValues.initSupply.toString()),
    };

    let emissionsDeployArg: EmissionsERC20DeployArgs;
    emissionsDeployArg = {
      allowDelegatedClaims: false,
      erc20Config,
      vmStateConfig,
    };

    newEmissionsERC20 = await EmissionsERC20.deploy(
      $signer,
      emissionsDeployArg
    );

    return newEmissionsERC20;
  };

  const handleClick = async () => {
    const { validationResult, fieldValues } = await validateFields(fields);
    if (!validationResult) return;
    deployPromise = deployEmissions(fieldValues);
  };
</script>

<div class="flex w-full gap-x-3">
  <div class="flex w-3/5 flex-col gap-y-4">
    <div class="mb-2 flex flex-col gap-y-2 w-full">
      <span class="text-2xl">Deploy a new ERC20 Token.</span>
      <span class="text-gray-400"> Mint a new ERC20 Token </span>
    </div>

    <FormPanel heading="ERC20 config">
      <Input
        type="text"
        placeholder="Name"
        bind:this={fields.erc20name}
        bind:value={erc20name}
        validator={required}
      >
        <span slot="label">Name</span>
      </Input>

      <Input
        type="text"
        placeholder="Symbol"
        bind:this={fields.erc20symbol}
        bind:value={erc20symbol}
        validator={required}
      >
        <span slot="label">Symbol</span>
      </Input>
      <Input
        type="address"
        placeholder="Name"
        bind:this={fields.ownerAddress}
        bind:value={ownerAddress}
        validator={addressValidate}
      >
        <span slot="label">Owner Address</span>
      </Input>
      {#if fixedSupply}
        <Input
          type="number"
          bind:this={fields.initSupply}
          bind:value={initSupply}
          validator={required}
        >
          <span slot="label">Initial Supply</span>
        </Input>
      {:else}
        <Input
          type="number"
          bind:this={fields.initSupply}
          bind:value={initSupply}
          validator={required}
        >
          <span slot="label">Total Supply (Fixed)</span>
        </Input>
      {/if}
    </FormPanel>

    <FormPanel>
      <div>
        <span class="font-bold">Supply Control</span>
        <Switch bind:checked={fixedSupply} />
        <br />
        <span class="text-gray-400"
          >ERC20 token will have fixed supply if switched off</span
        >
        {#if fixedSupply}
          <br /><br />
          <Input
            type="number"
            bind:this={fields.amount}
            bind:value={amount}
            validator={required}
          >
            <span slot="label"
              >Amount of tokens to mint each time in future</span
            >
          </Input>
        {/if}
      </div>
    </FormPanel>

    <FormPanel>
      <div>
        <span class="font-bold">Faucets</span>
        <Switch bind:checked={faucets} />
        <br />
        <span class="text-gray-400"
          >ERC20 token will be worked as faucets with ability to mint x number
          of tokens each x number of blocks passed</span
        >
      </div>
      {#if faucets}
        <Input
          type="number"
          bind:this={fields.blocks}
          bind:value={blocks}
          validator={required}
        >
          <span slot="label"> Number of blocks </span>
          <span slot="description">
            Number of blocks needs to pass before being able to do another
            faucet claim
          </span>
        </Input>
        <Input
          type="text"
          bind:this={fields.units}
          bind:value={units}
          validator={required}
        >
          <span slot="label"> Number of token(units) </span>
          <span slot="description">
            Number of token to be transfered by the fuacet each time it is
            triggered (at each claim)
          </span>
        </Input>
      {/if}
    </FormPanel>

    <FormPanel>
      {#if !deployPromise}
        <Button shrink on:click={handleClick}>Deploy ERC20 Token</Button>
      {:else}
        <ContractDeploy {deployPromise} type="ERC20 Token" />
      {/if}
    </FormPanel>
  </div>
</div>
